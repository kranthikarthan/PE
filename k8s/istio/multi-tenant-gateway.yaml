# Multi-Tenant Istio Gateway Configuration
# This configuration provides tenant isolation through host-based routing

---
# Main Gateway for tenant routing
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: payment-engine-multitenant-gateway
  namespace: payment-engine
  labels:
    app: payment-engine
    component: gateway
    version: v1
spec:
  selector:
    istio: ingressgateway
  servers:
  # HTTP redirect to HTTPS
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*.payment-engine.local"  # Wildcard for all tenant subdomains
    - "payment-engine.local"    # Main domain
    tls:
      httpsRedirect: true
  # HTTPS with wildcard certificate
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "*.payment-engine.local"  # All tenant subdomains
    - "payment-engine.local"    # Main domain
    tls:
      mode: SIMPLE
      credentialName: payment-engine-wildcard-tls

---
# Tenant-specific Gateway for tenant-001
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: tenant-001-gateway
  namespace: payment-engine
  labels:
    app: payment-engine
    component: gateway
    tenant: tenant-001
    version: v1
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "tenant-001.payment-engine.local"
    tls:
      mode: SIMPLE
      credentialName: tenant-001-tls

---
# Tenant-specific Gateway for tenant-002
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: tenant-002-gateway
  namespace: payment-engine
  labels:
    app: payment-engine
    component: gateway
    tenant: tenant-002
    version: v1
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "tenant-002.payment-engine.local"
    tls:
      mode: SIMPLE
      credentialName: tenant-002-tls

---
# Tenant-specific Gateway for tenant-003
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: tenant-003-gateway
  namespace: payment-engine
  labels:
    app: payment-engine
    component: gateway
    tenant: tenant-003
    version: v1
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "tenant-003.payment-engine.local"
    tls:
      mode: SIMPLE
      credentialName: tenant-003-tls

---
# Development Gateway for dev tenants
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: dev-gateway
  namespace: payment-engine
  labels:
    app: payment-engine
    component: gateway
    environment: development
    version: v1
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "*.dev.payment-engine.local"  # All dev tenant subdomains
    tls:
      mode: SIMPLE
      credentialName: dev-wildcard-tls

---
# Staging Gateway for staging tenants
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: staging-gateway
  namespace: payment-engine
  labels:
    app: payment-engine
    component: gateway
    environment: staging
    version: v1
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "*.staging.payment-engine.local"  # All staging tenant subdomains
    tls:
      mode: SIMPLE
      credentialName: staging-wildcard-tls

---
# Production Gateway for production tenants
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: production-gateway
  namespace: payment-engine
  labels:
    app: payment-engine
    component: gateway
    environment: production
    version: v1
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "*.prod.payment-engine.local"  # All production tenant subdomains
    tls:
      mode: SIMPLE
      credentialName: production-wildcard-tls