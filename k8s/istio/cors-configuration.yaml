apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: cors-filter
  namespace: payment-engine
  labels:
    app: cors-filter
    version: v1
spec:
  workloadSelector:
    labels:
      app: istio-ingressgateway
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: GATEWAY
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.cors
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors
          allow_origin_string_match:
          - prefix: "https://"
          - prefix: "http://localhost"
          - prefix: "http://127.0.0.1"
          - exact: "https://payment-engine.local"
          - exact: "https://frontend.payment-engine.local"
          - exact: "https://admin.payment-engine.local"
          - regex: "https://.*\\.payment-engine\\.local"
          allow_methods: "GET, POST, PUT, DELETE, OPTIONS, PATCH, HEAD"
          allow_headers: "Accept, Accept-Language, Content-Language, Content-Type, Authorization, X-Requested-With, X-Tenant-ID, X-Service-Type, X-Route-Context, X-Downstream-Route, X-Bank-Route, X-API-Key, X-Client-ID, X-Client-Secret"
          expose_headers: "X-Tenant-ID, X-Service-Type, X-Route-Context, X-Downstream-Route, X-Bank-Route, X-Request-ID, X-Response-Time"
          allow_credentials: true
          max_age: "86400"
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: cors-preflight-handler
  namespace: payment-engine
  labels:
    app: cors-preflight-handler
    version: v1
spec:
  workloadSelector:
    labels:
      app: istio-ingressgateway
  configPatches:
  - applyTo: HTTP_ROUTE
    match:
      context: GATEWAY
      routeConfiguration:
        vhost:
          route:
            match:
              headers:
              - name: ":method"
                string_match:
                  exact: "OPTIONS"
    patch:
      operation: MERGE
      value:
        route:
          direct_response:
            status: 200
            body:
              inline_string: "OK"
          response_headers_to_add:
          - header:
              key: "Access-Control-Allow-Origin"
              value: "*"
          - header:
              key: "Access-Control-Allow-Methods"
              value: "GET, POST, PUT, DELETE, OPTIONS, PATCH, HEAD"
          - header:
              key: "Access-Control-Allow-Headers"
              value: "Accept, Accept-Language, Content-Language, Content-Type, Authorization, X-Requested-With, X-Tenant-ID, X-Service-Type, X-Route-Context, X-Downstream-Route, X-Bank-Route, X-API-Key, X-Client-ID, X-Client-Secret"
          - header:
              key: "Access-Control-Expose-Headers"
              value: "X-Tenant-ID, X-Service-Type, X-Route-Context, X-Downstream-Route, X-Bank-Route, X-Request-ID, X-Response-Time"
          - header:
              key: "Access-Control-Allow-Credentials"
              value: "true"
          - header:
              key: "Access-Control-Max-Age"
              value: "86400"