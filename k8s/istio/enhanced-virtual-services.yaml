apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: payment-engine-vs
  namespace: payment-engine
  labels:
    app: payment-engine-vs
    version: v1
spec:
  hosts:
  - payment-engine.local
  - "*.payment-engine.local"
  gateways:
  - payment-engine-gateway
  http:
  # API Gateway Routes (replacing Spring Cloud Gateway)
  - match:
    - uri:
        prefix: /api/v1/
    route:
    - destination:
        host: payment-processing-service
        port:
          number: 8083
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
      retryOn: 5xx,reset,connect-failure,refused-stream
    fault:
      delay:
        percentage:
          value: 0.1
        fixedDelay: 5s
    headers:
      request:
        set:
          X-Forwarded-Proto: https
          X-Forwarded-For: "%DOWNSTREAM_REMOTE_ADDRESS%"
      response:
        set:
          X-Content-Type-Options: nosniff
          X-Frame-Options: DENY
          X-XSS-Protection: "1; mode=block"
  # Core Banking Routes
  - match:
    - uri:
        prefix: /api/v1/core-banking/
    route:
    - destination:
        host: core-banking-service
        port:
          number: 8081
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  # Auth Service Routes
  - match:
    - uri:
        prefix: /api/v1/auth/
    route:
    - destination:
        host: auth-service
        port:
          number: 8082
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  # Config Service Routes
  - match:
    - uri:
        prefix: /api/v1/config/
    route:
    - destination:
        host: config-service
        port:
          number: 8084
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  # Discovery Service Routes
  - match:
    - uri:
        prefix: /api/v1/discovery/
    route:
    - destination:
        host: discovery-service
        port:
          number: 8085
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  # Gateway Service Routes
  - match:
    - uri:
        prefix: /api/v1/gateway/
    route:
    - destination:
        host: gateway-service
        port:
          number: 8086
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  # Shared Service Routes
  - match:
    - uri:
        prefix: /api/v1/shared/
    route:
    - destination:
        host: shared-service
        port:
          number: 8087
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  # Enhanced Tenant Setup Routes (replacing API Gateway functionality)
  - match:
    - uri:
        prefix: /api/v1/enhanced-tenant-setup
    route:
    - destination:
        host: payment-processing-service
        port:
          number: 8083
    timeout: 60s
    retries:
      attempts: 2
      perTryTimeout: 30s
  # Multi-Level Auth Routes (replacing API Gateway functionality)
  - match:
    - uri:
        prefix: /api/v1/multi-level-auth/
    route:
    - destination:
        host: payment-processing-service
        port:
          number: 8083
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  # Certificate Management Routes (replacing API Gateway functionality)
  - match:
    - uri:
        prefix: /api/v1/certificates/
    route:
    - destination:
        host: payment-processing-service
        port:
          number: 8083
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  # Outgoing HTTP Routes (replacing API Gateway functionality)
  - match:
    - uri:
        prefix: /api/v1/outgoing-http/
    route:
    - destination:
        host: payment-processing-service
        port:
          number: 8083
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  # Health Check Routes
  - match:
    - uri:
        prefix: /actuator/health
    route:
    - destination:
        host: payment-processing-service
        port:
          number: 8083
    timeout: 10s
    retries:
      attempts: 1
      perTryTimeout: 5s
  # Default Route
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: payment-processing-service
        port:
          number: 8083
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: frontend-vs
  namespace: payment-engine
  labels:
    app: frontend-vs
    version: v1
spec:
  hosts:
  - frontend.payment-engine.local
  - "*.frontend.payment-engine.local"
  gateways:
  - frontend-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: frontend-service
        port:
          number: 3000
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
    headers:
      request:
        set:
          X-Forwarded-Proto: https
      response:
        set:
          X-Content-Type-Options: nosniff
          X-Frame-Options: DENY
          X-XSS-Protection: "1; mode=block"
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: tenant-specific-vs
  namespace: payment-engine
  labels:
    app: tenant-specific-vs
    version: v1
spec:
  hosts:
  - tenant-001.payment-engine.local
  - tenant-002.payment-engine.local
  - tenant-003.payment-engine.local
  - "*.tenant.payment-engine.local"
  gateways:
  - tenant-gateway
  http:
  # Tenant-specific routing with header injection
  - match:
    - headers:
        x-tenant-id:
          exact: "tenant-001"
    route:
    - destination:
        host: payment-processing-service
        port:
          number: 8083
    headers:
      request:
        set:
          X-Tenant-ID: "tenant-001"
          X-Service-Type: "payment-processing"
          X-Route-Context: "tenant-specific"
  - match:
    - headers:
        x-tenant-id:
          exact: "tenant-002"
    route:
    - destination:
        host: payment-processing-service
        port:
          number: 8083
    headers:
      request:
        set:
          X-Tenant-ID: "tenant-002"
          X-Service-Type: "payment-processing"
          X-Route-Context: "tenant-specific"
  - match:
    - headers:
        x-tenant-id:
          exact: "tenant-003"
    route:
    - destination:
        host: payment-processing-service
        port:
          number: 8083
    headers:
      request:
        set:
          X-Tenant-ID: "tenant-003"
          X-Service-Type: "payment-processing"
          X-Route-Context: "tenant-specific"
  # Default tenant route
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: payment-processing-service
        port:
          number: 8083
    headers:
      request:
        set:
          X-Service-Type: "payment-processing"
          X-Route-Context: "default"