@startuml MESSAGE_PROCESSING_ERD
!theme plain
title ISO 20022 Message Processing Entities ERD

entity "message_transactions" {
  * id : UUID <<PK>>
  --
  * tenant_id : UUID <<FK>>
  * correlation_id : VARCHAR(100) <<UK>>
  * message_type : VARCHAR(50)
  * source_message_type : VARCHAR(50)
  * target_message_type : VARCHAR(50)
  * status : VARCHAR(20)
  * processing_mode : VARCHAR(20)
  * response_mode : VARCHAR(20)
  * clearing_system_id : UUID <<FK>>
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * processed_at : TIMESTAMP
  * completed_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

entity "message_payloads" {
  * id : UUID <<PK>>
  --
  * transaction_id : UUID <<FK>>
  * message_type : VARCHAR(50)
  * payload_type : VARCHAR(20)
  * payload_data : TEXT
  * payload_size : INTEGER
  * checksum : VARCHAR(64)
  * is_encrypted : BOOLEAN
  * encryption_key_id : VARCHAR(100)
  * is_signed : BOOLEAN
  * signature : TEXT
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "message_transformations" {
  * id : UUID <<PK>>
  --
  * transaction_id : UUID <<FK>>
  * transformation_type : VARCHAR(50)
  * source_format : VARCHAR(20)
  * target_format : VARCHAR(20)
  * transformation_rules : TEXT
  * status : VARCHAR(20)
  * error_message : TEXT
  * processing_time_ms : INTEGER
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "message_validations" {
  * id : UUID <<PK>>
  --
  * transaction_id : UUID <<FK>>
  * validation_type : VARCHAR(50)
  * validation_status : VARCHAR(20)
  * validation_rules : TEXT
  * error_details : TEXT
  * validation_time_ms : INTEGER
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "clearing_system_interactions" {
  * id : UUID <<PK>>
  --
  * transaction_id : UUID <<FK>>
  * clearing_system_id : UUID <<FK>>
  * interaction_type : VARCHAR(50)
  * request_payload : TEXT
  * response_payload : TEXT
  * status_code : INTEGER
  * response_time_ms : INTEGER
  * retry_count : INTEGER
  * error_message : TEXT
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "webhook_deliveries" {
  * id : UUID <<PK>>
  --
  * transaction_id : UUID <<FK>>
  * webhook_url : VARCHAR(500)
  * delivery_status : VARCHAR(20)
  * http_status_code : INTEGER
  * response_body : TEXT
  * retry_count : INTEGER
  * max_retries : INTEGER
  * next_retry_at : TIMESTAMP
  * delivered_at : TIMESTAMP
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "kafka_messages" {
  * id : UUID <<PK>>
  --
  * transaction_id : UUID <<FK>>
  * topic_name : VARCHAR(100)
  * partition_id : INTEGER
  * offset : BIGINT
  * message_key : VARCHAR(255)
  * message_value : TEXT
  * headers : TEXT
  * status : VARCHAR(20)
  * produced_at : TIMESTAMP
  * consumed_at : TIMESTAMP
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "message_audit_logs" {
  * id : UUID <<PK>>
  --
  * transaction_id : UUID <<FK>>
  * event_type : VARCHAR(50)
  * event_action : VARCHAR(50)
  * event_status : VARCHAR(20)
  * event_details : TEXT
  * user_id : VARCHAR(100)
  * ip_address : VARCHAR(45)
  * user_agent : VARCHAR(500)
  * created_at : TIMESTAMP
}

' Relationships
message_transactions ||--o{ message_payloads : "contains"
message_transactions ||--o{ message_transformations : "transforms"
message_transactions ||--o{ message_validations : "validates"
message_transactions ||--o{ clearing_system_interactions : "interacts with"
message_transactions ||--o{ webhook_deliveries : "delivers via"
message_transactions ||--o{ kafka_messages : "produces to"
message_transactions ||--o{ message_audit_logs : "audits"

' Foreign key relationships to other entities
message_transactions }o--|| tenants : "belongs to"
message_transactions }o--|| clearing_systems : "uses"
clearing_system_interactions }o--|| clearing_systems : "interacts with"

' Indexes and constraints
note right of message_transactions
Indexes:
- idx_message_transactions_tenant_id (tenant_id)
- idx_message_transactions_correlation_id (correlation_id)
- idx_message_transactions_message_type (message_type)
- idx_message_transactions_status (status)
- idx_message_transactions_clearing_system_id (clearing_system_id)
- idx_message_transactions_created_at (created_at)
- idx_message_transactions_processed_at (processed_at)

Constraints:
- UK_message_transactions_correlation_id (correlation_id)
- FK_message_transactions_tenant_id (tenant_id)
- FK_message_transactions_clearing_system_id (clearing_system_id)
- CHK_message_transactions_status (status IN ('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'CANCELLED'))
- CHK_message_transactions_processing_mode (processing_mode IN ('SYNCHRONOUS', 'ASYNCHRONOUS', 'BATCH'))
- CHK_message_transactions_response_mode (response_mode IN ('IMMEDIATE', 'ASYNC', 'KAFKA', 'WEBHOOK'))
end note

note right of message_payloads
Indexes:
- idx_message_payloads_transaction_id (transaction_id)
- idx_message_payloads_message_type (message_type)
- idx_message_payloads_payload_type (payload_type)
- idx_message_payloads_created_at (created_at)

Constraints:
- FK_message_payloads_transaction_id (transaction_id)
- CHK_message_payloads_payload_type (payload_type IN ('REQUEST', 'RESPONSE', 'INTERMEDIATE'))
- CHK_message_payloads_is_encrypted (is_encrypted IN (true, false))
- CHK_message_payloads_is_signed (is_signed IN (true, false))
end note

note right of message_transformations
Indexes:
- idx_message_transformations_transaction_id (transaction_id)
- idx_message_transformations_transformation_type (transformation_type)
- idx_message_transformations_status (status)
- idx_message_transformations_created_at (created_at)

Constraints:
- FK_message_transformations_transaction_id (transaction_id)
- CHK_message_transformations_transformation_type (transformation_type IN ('PAIN001_TO_PACS008', 'PACS002_TO_PAIN002', 'PACS004_PROCESSING', 'PACS007_PROCESSING', 'PACS028_PROCESSING', 'CAMT054_PROCESSING', 'CAMT055_TO_CAMT029'))
- CHK_message_transformations_status (status IN ('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED'))
- CHK_message_transformations_source_format (source_format IN ('JSON', 'XML'))
- CHK_message_transformations_target_format (target_format IN ('JSON', 'XML'))
end note

note right of message_validations
Indexes:
- idx_message_validations_transaction_id (transaction_id)
- idx_message_validations_validation_type (validation_type)
- idx_message_validations_validation_status (validation_status)
- idx_message_validations_created_at (created_at)

Constraints:
- FK_message_validations_transaction_id (transaction_id)
- CHK_message_validations_validation_type (validation_type IN ('SCHEMA', 'BUSINESS_RULES', 'FIELD_VALIDATION', 'CROSS_FIELD_VALIDATION'))
- CHK_message_validations_validation_status (validation_status IN ('PENDING', 'VALID', 'INVALID', 'ERROR'))
end note

note right of clearing_system_interactions
Indexes:
- idx_clearing_system_interactions_transaction_id (transaction_id)
- idx_clearing_system_interactions_clearing_system_id (clearing_system_id)
- idx_clearing_system_interactions_interaction_type (interaction_type)
- idx_clearing_system_interactions_created_at (created_at)

Constraints:
- FK_clearing_system_interactions_transaction_id (transaction_id)
- FK_clearing_system_interactions_clearing_system_id (clearing_system_id)
- CHK_clearing_system_interactions_interaction_type (interaction_type IN ('PAYMENT_PROCESSING', 'STATUS_REQUEST', 'CANCELLATION', 'RETURN_PROCESSING', 'NOTIFICATION'))
end note

note right of webhook_deliveries
Indexes:
- idx_webhook_deliveries_transaction_id (transaction_id)
- idx_webhook_deliveries_delivery_status (delivery_status)
- idx_webhook_deliveries_retry_count (retry_count)
- idx_webhook_deliveries_next_retry_at (next_retry_at)
- idx_webhook_deliveries_created_at (created_at)

Constraints:
- FK_webhook_deliveries_transaction_id (transaction_id)
- CHK_webhook_deliveries_delivery_status (delivery_status IN ('PENDING', 'DELIVERED', 'FAILED', 'RETRYING', 'EXPIRED'))
- CHK_webhook_deliveries_retry_count (retry_count >= 0)
- CHK_webhook_deliveries_max_retries (max_retries >= 0)
end note

note right of kafka_messages
Indexes:
- idx_kafka_messages_transaction_id (transaction_id)
- idx_kafka_messages_topic_name (topic_name)
- idx_kafka_messages_partition_id (partition_id)
- idx_kafka_messages_offset (offset)
- idx_kafka_messages_status (status)
- idx_kafka_messages_produced_at (produced_at)

Constraints:
- FK_kafka_messages_transaction_id (transaction_id)
- CHK_kafka_messages_status (status IN ('PRODUCED', 'CONSUMED', 'FAILED', 'DLQ'))
- CHK_kafka_messages_partition_id (partition_id >= 0)
- CHK_kafka_messages_offset (offset >= 0)
end note

note right of message_audit_logs
Indexes:
- idx_message_audit_logs_transaction_id (transaction_id)
- idx_message_audit_logs_event_type (event_type)
- idx_message_audit_logs_event_action (event_action)
- idx_message_audit_logs_event_status (event_status)
- idx_message_audit_logs_user_id (user_id)
- idx_message_audit_logs_created_at (created_at)

Constraints:
- FK_message_audit_logs_transaction_id (transaction_id)
- CHK_message_audit_logs_event_type (event_type IN ('AUTHENTICATION', 'AUTHORIZATION', 'MESSAGE_PROCESSING', 'CLEARING_SYSTEM', 'WEBHOOK_DELIVERY', 'KAFKA_MESSAGE', 'SECURITY', 'SYSTEM'))
- CHK_message_audit_logs_event_action (event_action IN ('CREATE', 'READ', 'UPDATE', 'DELETE', 'PROCESS', 'TRANSFORM', 'VALIDATE', 'ROUTE', 'DELIVER', 'RETRY', 'FAIL'))
- CHK_message_audit_logs_event_status (event_status IN ('SUCCESS', 'FAILURE', 'PENDING', 'RETRY'))
end note

@enduml