@startuml COMPLETE_DATABASE_SCHEMA_ERD
!theme plain
title ISO 20022 Payment Engine - Complete Database Schema ERD

' Core Business Entities
entity "tenants" {
  * id : UUID <<PK>>
  --
  * name : VARCHAR(100)
  * code : VARCHAR(50) <<UK>>
  * status : VARCHAR(20)
  * contact_email : VARCHAR(255)
  * contact_phone : VARCHAR(50)
  * address : TEXT
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

entity "scheme_configs" {
  * id : UUID <<PK>>
  --
  * tenant_id : UUID <<FK>>
  * scheme_code : VARCHAR(50)
  * scheme_name : VARCHAR(100)
  * processing_mode : VARCHAR(20)
  * message_format : VARCHAR(10)
  * response_mode : VARCHAR(20)
  * is_active : BOOLEAN
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

entity "clearing_systems" {
  * id : UUID <<PK>>
  --
  * name : VARCHAR(100)
  * code : VARCHAR(50) <<UK>>
  * description : TEXT
  * endpoint_url : VARCHAR(500)
  * timeout_seconds : INTEGER
  * authentication_type : VARCHAR(20)
  * is_active : BOOLEAN
  * priority : INTEGER
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

entity "clearing_system_endpoints" {
  * id : UUID <<PK>>
  --
  * clearing_system_id : UUID <<FK>>
  * name : VARCHAR(100)
  * endpoint_type : VARCHAR(50)
  * message_type : VARCHAR(50)
  * message_format : VARCHAR(10)
  * response_mode : VARCHAR(20)
  * flow_direction : VARCHAR(30)
  * url : VARCHAR(500)
  * http_method : VARCHAR(10)
  * timeout_ms : INTEGER
  * retry_attempts : INTEGER
  * authentication_type : VARCHAR(20)
  * is_active : BOOLEAN
  * priority : INTEGER
  * description : VARCHAR(500)
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "tenant_clearing_system_mappings" {
  * id : UUID <<PK>>
  --
  * tenant_id : UUID <<FK>>
  * clearing_system_id : UUID <<FK>>
  * payment_type : VARCHAR(50)
  * local_instrument_code : VARCHAR(50)
  * is_active : BOOLEAN
  * priority : INTEGER
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

' Message Processing Entities
entity "message_transactions" {
  * id : UUID <<PK>>
  --
  * tenant_id : UUID <<FK>>
  * correlation_id : VARCHAR(100) <<UK>>
  * message_type : VARCHAR(50)
  * source_message_type : VARCHAR(50)
  * target_message_type : VARCHAR(50)
  * status : VARCHAR(20)
  * processing_mode : VARCHAR(20)
  * response_mode : VARCHAR(20)
  * clearing_system_id : UUID <<FK>>
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * processed_at : TIMESTAMP
  * completed_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

entity "message_payloads" {
  * id : UUID <<PK>>
  --
  * transaction_id : UUID <<FK>>
  * message_type : VARCHAR(50)
  * payload_type : VARCHAR(20)
  * payload_data : TEXT
  * payload_size : INTEGER
  * checksum : VARCHAR(64)
  * is_encrypted : BOOLEAN
  * encryption_key_id : VARCHAR(100)
  * is_signed : BOOLEAN
  * signature : TEXT
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "message_transformations" {
  * id : UUID <<PK>>
  --
  * transaction_id : UUID <<FK>>
  * transformation_type : VARCHAR(50)
  * source_format : VARCHAR(20)
  * target_format : VARCHAR(20)
  * transformation_rules : TEXT
  * status : VARCHAR(20)
  * error_message : TEXT
  * processing_time_ms : INTEGER
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "message_validations" {
  * id : UUID <<PK>>
  --
  * transaction_id : UUID <<FK>>
  * validation_type : VARCHAR(50)
  * validation_status : VARCHAR(20)
  * validation_rules : TEXT
  * error_details : TEXT
  * validation_time_ms : INTEGER
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "clearing_system_interactions" {
  * id : UUID <<PK>>
  --
  * transaction_id : UUID <<FK>>
  * clearing_system_id : UUID <<FK>>
  * interaction_type : VARCHAR(50)
  * request_payload : TEXT
  * response_payload : TEXT
  * status_code : INTEGER
  * response_time_ms : INTEGER
  * retry_count : INTEGER
  * error_message : TEXT
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "webhook_deliveries" {
  * id : UUID <<PK>>
  --
  * transaction_id : UUID <<FK>>
  * webhook_url : VARCHAR(500)
  * delivery_status : VARCHAR(20)
  * http_status_code : INTEGER
  * response_body : TEXT
  * retry_count : INTEGER
  * max_retries : INTEGER
  * next_retry_at : TIMESTAMP
  * delivered_at : TIMESTAMP
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "kafka_messages" {
  * id : UUID <<PK>>
  --
  * transaction_id : UUID <<FK>>
  * topic_name : VARCHAR(100)
  * partition_id : INTEGER
  * offset : BIGINT
  * message_key : VARCHAR(255)
  * message_value : TEXT
  * headers : TEXT
  * status : VARCHAR(20)
  * produced_at : TIMESTAMP
  * consumed_at : TIMESTAMP
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

' Security & Audit Entities
entity "users" {
  * id : UUID <<PK>>
  --
  * username : VARCHAR(100) <<UK>>
  * email : VARCHAR(255) <<UK>>
  * password_hash : VARCHAR(255)
  * first_name : VARCHAR(100)
  * last_name : VARCHAR(100)
  * status : VARCHAR(20)
  * last_login_at : TIMESTAMP
  * password_changed_at : TIMESTAMP
  * failed_login_attempts : INTEGER
  * locked_until : TIMESTAMP
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

entity "user_roles" {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  * role_name : VARCHAR(50)
  * tenant_id : UUID <<FK>>
  * is_active : BOOLEAN
  * granted_at : TIMESTAMP
  * granted_by : VARCHAR(100)
  * expires_at : TIMESTAMP
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "oauth_clients" {
  * id : UUID <<PK>>
  --
  * client_id : VARCHAR(100) <<UK>>
  * client_secret_hash : VARCHAR(255)
  * client_name : VARCHAR(100)
  * description : TEXT
  * redirect_uris : TEXT
  * scopes : TEXT
  * grant_types : TEXT
  * access_token_validity : INTEGER
  * refresh_token_validity : INTEGER
  * is_active : BOOLEAN
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

entity "oauth_tokens" {
  * id : UUID <<PK>>
  --
  * client_id : VARCHAR(100) <<FK>>
  * user_id : UUID <<FK>>
  * token_type : VARCHAR(20)
  * access_token : TEXT
  * refresh_token : TEXT
  * scopes : TEXT
  * expires_at : TIMESTAMP
  * issued_at : TIMESTAMP
  * is_revoked : BOOLEAN
  * revoked_at : TIMESTAMP
  * revoked_reason : VARCHAR(255)
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "encryption_keys" {
  * id : UUID <<PK>>
  --
  * key_name : VARCHAR(100) <<UK>>
  * key_type : VARCHAR(20)
  * key_algorithm : VARCHAR(50)
  * key_size : INTEGER
  * key_data : TEXT
  * key_version : INTEGER
  * is_active : BOOLEAN
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * expires_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

entity "audit_events" {
  * id : UUID <<PK>>
  --
  * event_id : VARCHAR(100) <<UK>>
  * event_type : VARCHAR(50)
  * event_action : VARCHAR(50)
  * user_id : VARCHAR(100)
  * tenant_id : UUID <<FK>>
  * resource_type : VARCHAR(50)
  * resource_id : VARCHAR(100)
  * event_status : VARCHAR(20)
  * event_details : TEXT
  * ip_address : VARCHAR(45)
  * user_agent : VARCHAR(500)
  * session_id : VARCHAR(100)
  * correlation_id : VARCHAR(100)
  * created_at : TIMESTAMP
}

' Monitoring & Metrics Entities
entity "system_metrics" {
  * id : UUID <<PK>>
  --
  * metric_name : VARCHAR(100)
  * metric_type : VARCHAR(20)
  * metric_value : DECIMAL(20,6)
  * metric_unit : VARCHAR(20)
  * labels : TEXT
  * timestamp : TIMESTAMP
  * service_name : VARCHAR(100)
  * instance_id : VARCHAR(100)
  * created_at : TIMESTAMP
}

entity "business_metrics" {
  * id : UUID <<PK>>
  --
  * tenant_id : UUID <<FK>>
  * metric_name : VARCHAR(100)
  * metric_type : VARCHAR(20)
  * metric_value : DECIMAL(20,6)
  * metric_unit : VARCHAR(20)
  * labels : TEXT
  * timestamp : TIMESTAMP
  * created_at : TIMESTAMP
}

entity "performance_metrics" {
  * id : UUID <<PK>>
  --
  * service_name : VARCHAR(100)
  * endpoint : VARCHAR(255)
  * method : VARCHAR(10)
  * response_time_ms : INTEGER
  * status_code : INTEGER
  * request_size_bytes : INTEGER
  * response_size_bytes : INTEGER
  * timestamp : TIMESTAMP
  * created_at : TIMESTAMP
}

entity "health_checks" {
  * id : UUID <<PK>>
  --
  * service_name : VARCHAR(100)
  * check_name : VARCHAR(100)
  * check_type : VARCHAR(50)
  * status : VARCHAR(20)
  * response_time_ms : INTEGER
  * error_message : TEXT
  * details : TEXT
  * timestamp : TIMESTAMP
  * created_at : TIMESTAMP
}

entity "alert_rules" {
  * id : UUID <<PK>>
  --
  * rule_name : VARCHAR(100) <<UK>>
  * rule_description : TEXT
  * metric_name : VARCHAR(100)
  * condition : VARCHAR(50)
  * threshold_value : DECIMAL(20,6)
  * severity : VARCHAR(20)
  * is_active : BOOLEAN
  * evaluation_interval : INTEGER
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

entity "alert_instances" {
  * id : UUID <<PK>>
  --
  * alert_rule_id : UUID <<FK>>
  * alert_name : VARCHAR(100)
  * severity : VARCHAR(20)
  * status : VARCHAR(20)
  * message : TEXT
  * metric_value : DECIMAL(20,6)
  * threshold_value : DECIMAL(20,6)
  * labels : TEXT
  * started_at : TIMESTAMP
  * resolved_at : TIMESTAMP
  * acknowledged_at : TIMESTAMP
  * acknowledged_by : VARCHAR(100)
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

' Configuration Management Entities
entity "tenant_configurations" {
  * id : UUID <<PK>>
  --
  * tenant_id : UUID <<FK>>
  * config_key : VARCHAR(100)
  * config_value : TEXT
  * config_type : VARCHAR(20)
  * is_encrypted : BOOLEAN
  * is_active : BOOLEAN
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

entity "service_configurations" {
  * id : UUID <<PK>>
  --
  * service_name : VARCHAR(100)
  * config_key : VARCHAR(100)
  * config_value : TEXT
  * config_type : VARCHAR(20)
  * environment : VARCHAR(50)
  * is_encrypted : BOOLEAN
  * is_active : BOOLEAN
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

entity "feature_flags" {
  * id : UUID <<PK>>
  --
  * flag_name : VARCHAR(100) <<UK>>
  * flag_description : TEXT
  * flag_value : BOOLEAN
  * tenant_id : UUID <<FK>>
  * environment : VARCHAR(50)
  * rollout_percentage : INTEGER
  * target_users : TEXT
  * is_active : BOOLEAN
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

' Fraud Risk Monitoring Entities
entity "fraud_risk_configurations" {
  * id : UUID <<PK>>
  --
  * tenant_id : UUID <<FK>>
  * payment_type : VARCHAR(50)
  * local_instrument_code : VARCHAR(50)
  * clearing_system_code : VARCHAR(50)
  * payment_source : VARCHAR(30)
  * risk_assessment_type : VARCHAR(30)
  * bank_fraud_api_config : JSONB
  * risk_rules : JSONB
  * decision_criteria : JSONB
  * is_active : BOOLEAN
  * priority : INTEGER
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

entity "fraud_risk_assessments" {
  * id : UUID <<PK>>
  --
  * assessment_id : VARCHAR(100) <<UK>>
  * transaction_reference : VARCHAR(100)
  * tenant_id : UUID <<FK>>
  * payment_source : VARCHAR(30)
  * risk_assessment_type : VARCHAR(30)
  * payment_type : VARCHAR(50)
  * local_instrument_code : VARCHAR(50)
  * clearing_system_code : VARCHAR(50)
  * status : VARCHAR(20)
  * decision : VARCHAR(20)
  * decision_reason : TEXT
  * risk_level : VARCHAR(20)
  * risk_score : DECIMAL(5,2)
  * assessed_at : TIMESTAMP
  * processing_time_ms : BIGINT
  * error_message : TEXT
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "fraud_api_toggle_configurations" {
  * id : UUID <<PK>>
  --
  * tenant_id : UUID <<FK>>
  * payment_type : VARCHAR(50)
  * local_instrument_code : VARCHAR(50)
  * clearing_system_code : VARCHAR(50)
  * is_enabled : BOOLEAN
  * enabled_reason : TEXT
  * disabled_reason : TEXT
  * effective_from : TIMESTAMP
  * effective_until : TIMESTAMP
  * priority : INTEGER
  * is_active : BOOLEAN
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  * created_by : VARCHAR(100)
  * updated_by : VARCHAR(100)
}

' Core Relationships
tenants ||--o{ scheme_configs : "has"
tenants ||--o{ tenant_clearing_system_mappings : "maps to"
tenants ||--o{ message_transactions : "processes"
tenants ||--o{ user_roles : "scopes"
tenants ||--o{ audit_events : "contains"
tenants ||--o{ business_metrics : "generates"
tenants ||--o{ tenant_configurations : "configures"
tenants ||--o{ feature_flags : "enables"
tenants ||--o{ fraud_risk_configurations : "configures"
tenants ||--o{ fraud_risk_assessments : "assesses"
tenants ||--o{ fraud_api_toggle_configurations : "toggles"

clearing_systems ||--o{ clearing_system_endpoints : "has"
clearing_systems ||--o{ tenant_clearing_system_mappings : "mapped by"
clearing_systems ||--o{ message_transactions : "uses"
clearing_systems ||--o{ clearing_system_interactions : "interacts with"

message_transactions ||--o{ message_payloads : "contains"
message_transactions ||--o{ message_transformations : "transforms"
message_transactions ||--o{ message_validations : "validates"
message_transactions ||--o{ clearing_system_interactions : "interacts with"
message_transactions ||--o{ webhook_deliveries : "delivers via"
message_transactions ||--o{ kafka_messages : "produces to"

users ||--o{ user_roles : "has"
users ||--o{ oauth_tokens : "owns"

oauth_clients ||--o{ oauth_tokens : "issues"

alert_rules ||--o{ alert_instances : "triggers"

' Indexes and constraints summary
note right of tenants
Core Business Entity:
- Multi-tenant architecture
- Tenant isolation
- Configuration management
- Audit trail
- Status management
end note

note right of message_transactions
Message Processing Core:
- ISO 20022 message processing
- Transaction lifecycle
- Status tracking
- Correlation management
- Performance monitoring
end note

note right of fraud_risk_configurations
Fraud Risk Configuration:
- Multi-level configuration
- Bank's fraud API integration
- Risk rules and criteria
- Priority-based resolution
- Dynamic configuration
end note

note right of fraud_risk_assessments
Fraud Risk Assessment:
- Real-time risk assessment
- Decision tracking
- Risk scoring
- Performance monitoring
- Audit trail
end note

note right of fraud_api_toggle_configurations
Fraud API Toggle:
- Dynamic enable/disable
- Multi-level control
- Priority resolution
- Effective date management
- Audit trail
end note

note right of users
Security & Authentication:
- User management
- Role-based access control
- OAuth2 integration
- Password security
- Account locking
end note

note right of system_metrics
Monitoring & Observability:
- System metrics collection
- Performance monitoring
- Health checks
- Alerting
- Business metrics
end note

note right of tenant_configurations
Configuration Management:
- Dynamic configuration
- Environment-specific settings
- Feature flags
- Configuration validation
- Change tracking
end note

@enduml